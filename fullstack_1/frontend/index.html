<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
</head>

<body>
  <div id="root"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.4.1/umd/react.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.4.1/umd/react-dom.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.0/redux.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/5.0.7/react-redux.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <script type="text/babel">
    const OBJECTIVES = [
      { "id": 1, "title": "First objective", "start": 0, "target": 50, "current": 20, "start_date": "2018-01-05", "end_date": "2018-03-05" },
      { "id": 2, "title": "Second objective", "start": 10, "target": 42, "current": 20, "start_date": "2018-01-25", "end_date": "2018-03-30", "parent_id": 1 },
      { "id": 3, "title": "Old objective", "start": 20, "target": 0, "current": 20, "start_date": "2018-02-05", "end_date": "2018-03-05", "parent_id": 4 },
      { "id": 4, "title": "French objective", "start": 0, "target": 50, "current": 60, "start_date": "2018-01-05", "end_date": "2018-03-05", "parent_id": 2 },
      { "id": 5, "title": "Void objective", "start": 10, "target": 42, "current": -20, "start_date": "2018-01-25", "end_date": "2018-03-30", "parent_id": 2 }
    ];
    const TODAY = "2018-02-20";

    const dateDiffInDays = (date1, date2) => {
      const millisecondsByDay = 86400000;
      return (date2 - date1) / millisecondsByDay;
    };

    const getObjectivesWithChildren = objectives => {
      // return the objectives in a nested tree by adding a children key in the objectives to store the children objectives in an array
      const objectivesWithChildren = objectives.map(objective => ({...objective, children: []}));
      
      objectivesWithChildren.reduce((acc, objective) => {
          if (objective.parent_id) {
            acc.find(({ id }) => objective.parent_id === id).children.push(objective);
          }
          return acc;
        }
        , objectivesWithChildren);

      const root = objectivesWithChildren.find(({parent_id}) => !parent_id);
      return root;
    };

    class Curve extends React.Component {
      componentDidMount() {
        const {start, current, target, start_date, end_date} = this.props.objective;
        const trace = {
          x: [new Date(start_date), new Date(TODAY), new Date(end_date)],
          y: [start, current, target],
          type: 'scatter'
        }
        const layout = {
          yaxis: {
            rangemode: 'tozero',
            showline: true,
            zeroline: true
          },
          autosize: false,
          width: 300,
          height: 150,
          margin: {
            l: 40,
            r: 40,
            b: 40,
            t: 40,
          },
        };

        Plotly.newPlot(`curve${this.props.objective.id}`, [trace], layout);
      }
      render() {
        const style = {
          width: '512',
          height: '256'
        };
        return <div id={`curve${this.props.objective.id}`} style={style}/>;
      }
    };

    class Objective extends React.Component {
      state = { expanded: false};
      
      expand = () => this.setState({expanded : !this.state.expanded});

      render() {
        const { objective } = this.props;
        const containerStyle = {
          display: 'flex',
          flexDirection: 'column',
        };
        const objectiveStyle = {
          display: 'flex',
          alignItems: 'center'
        };
        const titleStyle = {
          width: '150px',
          height: '75px',
          borderRadius: '3px',
          border: 'none',
          flexShrink: 0
        };
        const childrenContainerStyle = {
          paddingLeft: '100px',
        };
        return (
          <div style={containerStyle}>
            <div style={objectiveStyle}>
              <button onClick={this.expand} style={titleStyle}>{objective.title}</button>
              {this.state.expanded && <Curve objective={objective} />}
            </div>
            {this.state.expanded && 
              <div style={childrenContainerStyle}>
                {objective.children.map(childObjective => <Objective objective={childObjective} />)}
              </div>}
          </div>
        );
      }
    };

    const App = () => {
      const reachedObjectivesCount = OBJECTIVES.filter(({ current, target }) => current >= target).length;
      const objectivesTree = getObjectivesWithChildren(OBJECTIVES);
      return (
        <div>
          <h1>CHALLENGE JAVELO</h1>
          <p>
            {reachedObjectivesCount} objectives have their current value over their target
          </p>
          <div>
            <Objective key={objectivesTree.id} objective={objectivesTree} />
          </div>
        </div>
      );
    };


    ReactDOM.render(
      <App/>,
      document.getElementById('root')
    );
  </script>
</body>

</html>